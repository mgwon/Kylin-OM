//主机列表组件开始
    const HostDetailPage = ({ host, onReturnToList, onAddRepairRecord }) => {
        // State for managing the active tab ('unfixed' or 'fixed')
        const [activeTab, setActiveTab] = React.useState('unfixed');
        // State for tracking which CVE items are expanded
        const [expandedRows, setExpandedRows] = React.useState({});
        // State for selected CVEs for batch operations
        const [selectedCves, setSelectedCves] = React.useState([]);
        // State for selected RPMs within each expanded CVE
        const [selectedRpms, setSelectedRpms] = React.useState({});
        // State for CVE search term
        const [searchTerm, setSearchTerm] = React.useState('');
        // State for pagination
        const [currentPage, setCurrentPage] = React.useState(1);
        const [pageSize, setPageSize] = React.useState(10);
        // State for CVE list refreshing
        const [isRefreshing, setIsRefreshing] = React.useState(false);

        // 【新增功能】管理任务创建模态框的状态
        const [isTaskModalOpen, setIsTaskModalOpen] = React.useState(false);
        // 【新增功能】用于区分模态框是用于“修复”还是“移除”
        const [modalTaskType, setModalTaskType] = React.useState(null); // 'repair' 或 'removal'

        // Memoize the list of CVEs to display based on the active tab and search term
        const cveList = React.useMemo(() => {
            const sourceList = activeTab === 'unfixed' ? (host.unfixed_cves || []) : (host.fixed_cves || []);
            if (!searchTerm) {
            return sourceList;
            }
            return sourceList.filter(cve => cve.cve_id.toLowerCase().includes(searchTerm.toLowerCase()));
        }, [activeTab, host, searchTerm]);

        // Paginated list
        const paginatedCveList = cveList.slice((currentPage - 1) * pageSize, currentPage * pageSize);

        // Reset states when tab changes
        React.useEffect(() => {
            setCurrentPage(1);
            setSelectedCves([]);
            setSelectedRpms({});
            setExpandedRows({});
        }, [activeTab]);

        // Helper function to toggle the expansion of a CVE row
        const toggleRowExpansion = (cveId) => {
            setExpandedRows(prev => ({ ...prev, [cveId]: !prev[cveId] }));
        };

        // Handle selecting/deselecting all CVEs on the current page
        const handleSelectAllCves = (e) => {
            if (e.target.checked) {
            const currentPageIds = paginatedCveList.map(cve => cve.cve_id);
            setSelectedCves(prev => [...new Set([...prev, ...currentPageIds])]);
            } else {
            const currentPageIds = paginatedCveList.map(cve => cve.cve_id);
            setSelectedCves(prev => prev.filter(id => !currentPageIds.includes(id)));
            }
        };

        // Handle selecting/deselecting a single CVE
        const handleSelectCve = (e, cveId) => {
            if (e.target.checked) {
            setSelectedCves(prev => [...prev, cveId]);
            } else {
            setSelectedCves(prev => prev.filter(id => id !== cveId));
            }
        };
        
        const isAllOnPageSelected = paginatedCveList.length > 0 && paginatedCveList.every(cve => selectedCves.includes(cve.cve_id));

        // Handlers for sub-table (RPMs) selection
        const handleSelectAllRpms = (e, cveId, rpms) => {
            const rpmNames = rpms.map(rpm => rpm.name);
            setSelectedRpms(prev => ({
            ...prev,
            [cveId]: e.target.checked ? rpmNames : []
            }));
        };

        const handleSelectRpm = (e, cveId, rpmName) => {
            const currentSelected = selectedRpms[cveId] || [];
            const newSelected = e.target.checked
            ? [...currentSelected, rpmName]
            : currentSelected.filter(name => name !== rpmName);
            setSelectedRpms(prev => ({
            ...prev,
            [cveId]: newSelected
            }));
        };

        // ==================================================================
        // API 模拟函数
        // ==================================================================
        const handleScan = () => {
            // 未来API接口实现:
            // 1. 向后端发送扫描请求，通常包含主机ID或IP。
            /*
            const apiEndpoint = `/api/hosts/${host.id}/scan`;
            fetch(apiEndpoint, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                alert(`任务 ${data.taskId} 已创建`);
                // 可能需要轮询任务状态或使用WebSocket更新
            })
            .catch(err => console.error("扫描请求失败:", err));
            */
            
            console.log(`模拟API请求：对主机 ${host.name} (${host.ip}) 发起漏洞扫描。`);
            alert(`已为${host.name}创建漏洞扫描任务 (模拟)`);
        };
        
        // 【修改点】点击“生成修复任务”按钮的逻辑
        const handleCreateFixTask = () => {
            if ((host.unfixed_cves || []).length === 0) {
                alert("该主机没有未修复的CVE，无法创建修复任务。");
                return;
            }
            setModalTaskType('repair');
            setIsTaskModalOpen(true);
        };

        // 【修改点】点击“生成热补丁移除任务”按钮的逻辑
        const handleCreateHotpatchRemoveTask = () => {
            if ((host.fixed_cves || []).length === 0) {
                alert("该主机没有已修复的CVE，无法创建热补丁移除任务。");
                return;
            }
            setModalTaskType('removal');
            setIsTaskModalOpen(true);
        };
        
        // 【新增功能】处理从模态框提交的任务
        const handleSubmitTask = async (taskInfo) => {
            const { taskName, taskDescription, cvesToProcess, taskType, isImmediate } = taskInfo;
            
            // 准备发送到后端的数据
            const newRecordPayload = {
                name: taskName,
                description: taskDescription,
                hostCount: 1, 
                type: taskType === 'repair' ? 'cve修复' : '热补丁移除',
                status: { success: 0, fail: 0, running: 0, unknown: 1 },
                creationTime: new Date().toLocaleString('zh-CN', { hour12: false }),
                cve_ids: cvesToProcess.map(c => c.cve_id),
                // 传递关联的主机信息，方便后端创建详情
                affected_hosts: [{
                    hostname: host.name,
                    ip: host.ip,
                    group: host.group,
                    repo: host.repo,
                    last_scan: host.lastScan,
                    repairStatus: '未知',
                    repairStatusColor: 'text-gray-500'
                }]
            };
            
            try {
                // --- API 调用 ---
                const response = await fetch('/api/vulnerability/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newRecordPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || '创建任务失败');
                }
                
                const createdTask = await response.json(); // 获取后端返回的完整任务对象

            
            // 统一调用全局函数来创建任务并跳转
            if (onAddRepairRecord) {
                onAddRepairRecord(newRecord);
            } else {
                console.error("onAddRepairRecord function is not passed to HostDetailPage.");
                alert("创建任务失败：缺少页面跳转处理器。");
            }

            if (isImmediate) {
                const execResponse = await fetch(`/api/vulnerability/tasks/${createdTask.id}/execute`, {
                    method: 'POST'
                });
                if (!execResponse.ok) throw new Error('任务创建成功，但执行失败');

                setTimeout(() => {
                    const actionText = taskType === 'repair' ? '修复' : '移除';
                    alert(`已为 ${newRecordPayload.cve_ids.join(', ')} 创建并执行${actionText}任务。`);
                }, 100);
            }
            
            // 任务创建成功后，关闭模态框并清空选择
            setIsTaskModalOpen(false);
            setSelectedCves([]);
            setSelectedRpms({});

        } catch(error) {
            console.error("任务创建或执行失败:", error);
            alert(error.message);
        }
    };

        const handleRefreshCves = () => {
            console.log("开始刷新CVE列表...");
            setIsRefreshing(true);

            // 未来API接口实现:
            // 在真实应用中，这里会是一个fetch请求，
            // 注意：这个API需要返回一个完整的主机对象结构，与props中的host一致
            /*
            fetch(`/api/hosts/${host.id}/cves`)
            .then(res => res.json())
            .then(newHostData => {
                // 这里需要一个从App组件传下来的方法来更新整个host对象
                // 例如: onHostUpdate(newHostData); 
                // 由于我们没有这个方法，所以这里只做模拟
                console.log("获取到新的主机数据:", newHostData);
            })
            .catch(err => console.error("刷新CVE列表失败:", err))
            .finally(() => setIsRefreshing(false));
            */

            // 当前使用setTimeout模拟网络延迟
            setTimeout(() => {
            console.log("CVE列表刷新完成 (模拟)");
            setIsRefreshing(false);
            }, 800);
        };

        const handleExportCves = () => {
            // 1. 确定要导出的数据
            let dataToExport;
            const allCves = [...(host.unfixed_cves || []), ...(host.fixed_cves || [])];

            if (selectedCves.length > 0) {
            dataToExport = allCves.filter(cve => selectedCves.includes(cve.cve_id));
            if (window.confirm(`确定要导出已选择的 ${dataToExport.length} 条CVE信息吗？`) === false) return;
            } else {
            dataToExport = cveList;
            if (dataToExport.length === 0) {
                alert("当前列表没有可导出的CVE信息。");
                return;
            }
            if (window.confirm(`确定要导出当前 "${activeTab === 'unfixed' ? '未修复' : '已修复'}" 列表中的全部 ${dataToExport.length} 条CVE信息吗？`) === false) return;
            }

            // 2. 将JSON数据转换为CSV字符串
            const headers = ['CVE_ID', '状态', '发布时间', '软件包', '严重性', 'CVSS分数', '描述', '受影响RPM', '修复建议'];
            const csvRows = [headers.join(',')];

            for (const cve of dataToExport) {
            const status = (host.unfixed_cves || []).some(uc => uc.cve_id === cve.cve_id) ? '未修复' : '已修复';
            const affectedRpmsStr = (cve.affected_rpms || []).map(rpm => rpm.name).join('; ');
            const fixSuggestionsStr = (cve.affected_rpms || []).map(rpm => `${rpm.fix_suggestion.type}: ${rpm.fix_suggestion.package_to_install}`).join('; ');
            const description = `"${(cve.description || '').replace(/"/g, '""')}"`;
            const row = [cve.cve_id, status, cve.publish_time, cve.software_package, cve.severity, cve.cvss_score, description, `"${affectedRpmsStr}"`, `"${fixSuggestionsStr}"`].join(',');
            csvRows.push(row);
            }

            const csvContent = csvRows.join('\n');

            // 3. 创建并触发下载
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            link.href = url;
            link.setAttribute('download', `cve-info-${host.name}-${timestamp}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        // 【新增功能】根据选择和上下文，决定哪些CVE将进入模态框
        const cvesForModal = React.useMemo(() => {
            if (!modalTaskType) return [];
            const isRepair = modalTaskType === 'repair';
            const sourceList = isRepair ? (host.unfixed_cves || []) : (host.fixed_cves || []);

            if (selectedCves.length > 0) {
                // 如果用户有勾选，则使用勾选的CVE
                return sourceList.filter(cve => selectedCves.includes(cve.cve_id));
            }
            // 如果用户没有勾选，则默认使用当前标签页下的所有CVE
            return sourceList;
        }, [selectedCves, modalTaskType, host]);

        // 【新增功能】在 HostDetailPage 内部定义任务创建模态框组件
        const TaskCreationModal = ({ isOpen, onClose, taskType, cvesToProcess, hostInfo, onSubmitTask }) => {
            if (!isOpen) return null;
            
            const isRepair = taskType === 'repair';
            const title = isRepair ? '生成修复任务' : '生成热补丁移除任务';
            const taskTypeName = isRepair ? 'cve修复' : '热补丁移除';
            
            const cveIds = cvesToProcess.map(cve => cve.cve_id).join('、');
            const defaultTaskName = isRepair ? `修复主机 ${hostInfo.name} 的 ${cvesToProcess.length} 个 CVE` : `移除主机 ${hostInfo.name} 的 ${cvesToProcess.length} 个热补丁`;
            const defaultDescription = `为 主机 ${hostInfo.name} (${hostInfo.ip}) ${isRepair ? '修复' : '移除'}以下CVE: ${cveIds.substring(0, 100)}${cveIds.length > 100 ? '...' : ''}`;

            const [taskName, setTaskName] = React.useState(defaultTaskName);
            const [taskDescription, setTaskDescription] = React.useState(defaultDescription);
            const [isAccept, setIsAccept] = React.useState(false);
            const [isColdPatch, setIsColdPatch] = React.useState(false);
            const [visibleTooltip, setVisibleTooltip] = React.useState(null); // State for tooltip visibility
            
            const handleSubmit = (isImmediate) => {
                if (!taskName.trim() || !taskDescription.trim()) {
                    alert('任务名称和任务描述不能为空！');
                    return;
                }
                onSubmitTask({ taskName, taskDescription, cvesToProcess, taskType, isImmediate, options: { isAccept, isColdPatch } });
            };
            
            // 【修改点】ToggleSwitch 组件现在内部处理 tooltip 逻辑
            const ToggleSwitch = ({ label, tooltipText, tooltipId, checked, onChange }) => (
                <div className="flex items-center">
                    <label className="text-sm text-gray-600">{label}：</label>
                    <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" checked={checked} onChange={onChange} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    {tooltipText && (
                        <div className="relative flex items-center">
                            <span 
                                onClick={(e) => { e.stopPropagation(); setVisibleTooltip(prev => prev === tooltipId ? null : tooltipId); }}
                                className="w-4 h-4 bg-gray-200 text-gray-600 flex items-center justify-center rounded-full text-xs font-bold cursor-pointer"
                            >?</span>
                            {visibleTooltip === tooltipId && (
                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-gray-800 text-white text-xs rounded py-1.5 px-2.5 z-10 shadow-lg">
                                    {tooltipText}
                                    <div className="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-l-transparent border-r-4 border-r-transparent border-t-4 border-t-gray-800"></div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-end z-50" onClick={onClose}>
                    <div className="bg-white shadow-xl h-full w-full max-w-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-lg font-semibold text-gray-900">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-700 text-3xl font-light">×</button>
                        </div>
                        <div className="p-6 flex-grow overflow-y-auto space-y-6 bg-gray-50">
                            <div className="grid grid-cols-3 items-center"><label className="text-sm text-gray-600 col-span-1">任务类型：</label><p className="text-sm text-gray-800 col-span-2">{taskTypeName}</p></div>
                            <div className="grid grid-cols-3 items-start"><label className="text-sm text-gray-600 pt-2 col-span-1"><span className="text-red-500 mr-1">*</span>任务名称：</label><input type="text" value={taskName} onChange={e => setTaskName(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm col-span-2" /></div>
                            <div className="grid grid-cols-3 items-start"><label className="text-sm text-gray-600 pt-2 col-span-1"><span className="text-red-500 mr-1">*</span>任务描述：</label><textarea rows="3" value={taskDescription} onChange={e => setTaskDescription(e.target.value)} className="w-full border border-gray-300 rounded-md px-3 py-1.5 text-sm col-span-2"></textarea></div>
                            
                            {/* 【修改点】为ToggleSwitch传递tooltip相关的props */}
                            {isRepair && (
                                <React.Fragment>
                                    <div className="grid grid-cols-3 items-center">
                                        <ToggleSwitch 
                                            label="是否accept" 
                                            checked={isAccept} 
                                            onChange={() => setIsAccept(!isAccept)}
                                            tooltipText="勾选后会在重启后自动激活此次修复使用的热补丁"
                                            tooltipId="accept"
                                        />
                                    </div>
                                    <div className="grid grid-cols-3 items-center">
                                        <ToggleSwitch 
                                            label="冷补丁升级" 
                                            checked={isColdPatch} 
                                            onChange={() => setIsColdPatch(!isColdPatch)}
                                            tooltipText="勾选后，会同步生成热补丁对应的冷补丁的修复任务。"
                                            tooltipId="coldPatch"
                                        />
                                    </div>
                                </React.Fragment>
                            )}
                            
                            <div className="border rounded-md bg-white flex flex-col" style={{height: '250px'}}>
                                <div className="flex-shrink-0 border-b">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gray-50"><tr><th className="p-2 font-medium text-gray-600 text-left">CVE_ID</th></tr></thead>
                                    </table>
                                </div>
                                <div className="overflow-y-auto">
                                    <table className="w-full text-sm text-left"><tbody className="text-gray-700">
                                        {cvesToProcess.map(cve => (
                                            <tr key={cve.cve_id} className="border-t">
                                                <td className="p-2 flex items-center"><span className="text-gray-400 mr-2">[+]</span>{cve.cve_id}</td>
                                            </tr>
                                        ))}
                                    </tbody></table>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end items-center p-4 border-t bg-white space-x-3">
                            <button onClick={onClose} className="px-4 py-1.5 border rounded-md text-sm hover:bg-gray-100 font-semibold text-gray-800">取消</button>
                            <button onClick={() => handleSubmit(false)} className="px-4 py-1.5 rounded-md text-sm font-semibold bg-blue-500 text-white hover:bg-blue-600">创建</button>
                            <button onClick={() => handleSubmit(true)} className="px-4 py-1.5 rounded-md text-sm font-semibold bg-blue-600 text-white hover:bg-blue-700">立即执行</button>
                        </div>
                    </div>
                </div>
            );
        };

        return (
            <>
                <div className="space-y-6">
                {/* Host Info Card */}
                <div className="bg-white p-6 rounded-lg shadow-md">
                    {/* 【修改点】将标题容器修改为flex布局，以便在右侧添加按钮 */}
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">{host.name}</h2>
                        {/* 【新增功能】添加“返回主机页面”按钮 */}
                        <button 
                            onClick={onReturnToList} 
                            className="text-sm font-medium text-blue-600 hover:underline flex items-center"
                        >
                            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            返回主机列表
                        </button>
                    </div>
                    <div className="grid grid-cols-3 gap-x-8 items-start">
                    <div className="col-span-1">
                        <div className="text-sm text-gray-500 space-y-1">
                        <p>主机组: {host.group}</p>
                        <p>IP: {host.ip}</p>
                        </div>
                        <div className="mt-4 space-x-2">
                        <button onClick={handleScan} className="bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700 text-sm">漏洞扫描</button>
                        <button onClick={handleExportCves} className="bg-white border border-gray-300 text-gray-700 px-4 py-1.5 rounded-md hover:bg-gray-50 text-sm">导出cve信息</button>
                        </div>
                    </div>
                    <div className="col-span-1 text-sm text-gray-500 space-y-1">
                        <p>未修复的CVE数量: {host.cve_stats.unfixed}</p>
                        <p>已修复的CVE数量: {host.cve_stats.fixed}</p>
                        <p>不受影响的CVE数量: {host.cve_stats.unaffected}</p>
                    </div>
                    <div className="col-span-1 text-sm text-gray-500 space-y-1">
                        <p>CVE REPO: {host.repo}</p>
                        <p>上次扫描: {host.lastScan}</p>
                    </div>
                    </div>
                </div>

                {/* CVEs List Card (保持不变) */}
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center space-x-4">
                        <div className="flex items-center space-x-1 border border-gray-300 rounded-md p-0.5">
                        <button onClick={() => setActiveTab('unfixed')} className={`px-4 py-1 rounded-md text-sm ${activeTab === 'unfixed' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`}>未修复</button>
                        <button onClick={() => setActiveTab('fixed')} className={`px-4 py-1 rounded-md text-sm ${activeTab === 'fixed' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}`}>已修复</button>
                        </div>
                        <div className="relative">
                        <input type="text" placeholder="按CVE ID搜索" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="border border-gray-300 rounded-md pl-8 pr-2 py-1.5 text-sm w-48"/>
                        <svg className="w-4 h-4 absolute left-2 top-1/2 -translate-y-1/2 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd"></path></svg>
                        </div>
                    </div>
                    <div className="flex items-center space-x-2">
                        {activeTab === 'unfixed' && <button onClick={handleCreateFixTask} className="bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700 text-sm">生成修复任务</button>}
                        {activeTab === 'fixed' && <button onClick={handleCreateHotpatchRemoveTask} className="bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700 text-sm">生成热补丁移除任务</button>}
                        <button onClick={handleRefreshCves} disabled={isRefreshing} className="bg-white border border-gray-300 text-gray-700 p-1.5 rounded-md hover:bg-gray-50 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" className={`w-5 h-5 ${isRefreshing ? 'animate-spin' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v6h6M20 20v-6h-6M4 10a9 9 0 0115.89-3.56M20 14a9 9 0 01-15.89 3.56" /></svg>
                        </button>
                    </div>
                    </div>

                    {/* CVEs Table */}
                    <div className="overflow-x-auto">
                    <table className="min-w-full text-sm text-left">
                        <thead className="bg-gray-50">
                        <tr>
                            <th className="p-3 w-10"><input type="checkbox" checked={isAllOnPageSelected} onChange={handleSelectAllCves} /></th>
                            <th className="p-3 font-semibold text-gray-600">CVE_ID</th>
                            <th className="p-3 font-semibold text-gray-600">发布时间</th>
                            <th className="p-3 font-semibold text-gray-600">软件包</th>
                            <th className="p-3 font-semibold text-gray-600">严重性</th>
                            <th className="p-3 font-semibold text-gray-600">CVSS 分数</th>
                        </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                        {isRefreshing ? (
                            <tr><td colSpan="6" className="p-10 text-center text-gray-500">正在刷新...</td></tr>
                        ) : paginatedCveList.map(cve => {
                            const allRpmsInCve = cve.affected_rpms || [];
                            const selectedRpmsInCve = selectedRpms[cve.cve_id] || [];
                            const isAllRpmInCveSelected = allRpmsInCve.length > 0 && selectedRpmsInCve.length === allRpmsInCve.length;

                            return (
                            <React.Fragment key={cve.cve_id}>
                                <tr className="hover:bg-gray-50">
                                <td className="p-3"><input type="checkbox" checked={selectedCves.includes(cve.cve_id)} onChange={(e) => handleSelectCve(e, cve.cve_id)} /></td>
                                <td className="p-3">
                                    <span onClick={() => toggleRowExpansion(cve.cve_id)} className="cursor-pointer text-blue-600 hover:underline">
                                    <span className="font-mono text-xs inline-block transform transition-transform duration-200" style={{ transform: expandedRows[cve.cve_id] ? 'rotate(90deg)' : 'rotate(0deg)' }}>▶</span> {cve.cve_id}
                                    </span>
                                </td>
                                <td className="p-3 text-gray-800">{cve.publish_time}</td>
                                <td className="p-3 text-gray-800">{cve.software_package}</td>
                                <td className="p-3 text-red-600 font-medium">{cve.severity}</td>
                                <td className="p-3 text-gray-800">{cve.cvss_score}</td>
                                </tr>
                                {expandedRows[cve.cve_id] && (
                                <tr className="bg-gray-50">
                                    <td colSpan="6" className="p-4">
                                    <div className="bg-white p-4 rounded-md border">
                                        <p className="font-semibold text-gray-700">Description:</p>
                                        <p className="text-gray-600 mb-4">{cve.description}</p>
                                        <table className="min-w-full text-sm">
                                        <thead className="bg-gray-100">
                                            <tr>
                                            <th className="p-2 w-10"><input type="checkbox" checked={isAllRpmInCveSelected} onChange={(e) => handleSelectAllRpms(e, cve.cve_id, allRpmsInCve)} /></th>
                                            <th className="p-2 text-left font-semibold text-gray-600">受影响rpm</th>
                                            <th className="p-2 text-left font-semibold text-gray-600">待安装rpm</th>
                                            <th className="p-2 text-left font-semibold text-gray-600">修复方式</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {allRpmsInCve.map(rpm => (
                                            <tr key={rpm.name}>
                                                <td className="p-2"><input type="checkbox" checked={selectedRpmsInCve.includes(rpm.name)} onChange={(e) => handleSelectRpm(e, cve.cve_id, rpm.name)} /></td>
                                                <td className="p-2 text-gray-800">{rpm.name}</td>
                                                <td className="p-2 text-gray-800">{rpm.fix_suggestion.package_to_install}</td>
                                                <td className="p-2 text-gray-800">{rpm.fix_suggestion.type}</td>
                                            </tr>
                                            ))}
                                        </tbody>
                                        </table>
                                    </div>
                                    </td>
                                </tr>
                                )}
                            </React.Fragment>
                            )
                        })}
                        </tbody>
                    </table>
                    </div>
                    <div className="flex justify-end items-center pt-4">
                    <Pagination 
                        currentPage={currentPage} 
                        totalItems={cveList.length} 
                        pageSize={pageSize} 
                        onPageChange={setCurrentPage} 
                        onPageSizeChange={(size) => { setPageSize(size); setCurrentPage(1); }} 
                    />
                    </div>
                </div>
                </div>
                {/* 【新增功能】渲染任务创建模态框 */}
                <TaskCreationModal
                    isOpen={isTaskModalOpen}
                    onClose={() => setIsTaskModalOpen(false)}
                    taskType={modalTaskType}
                    cvesToProcess={cvesForModal}
                    hostInfo={host}
                    onSubmitTask={handleSubmitTask}
                />
                {/* 添加一些样式来美化ToggleSwitch */}
                <style>{`
                    .toggle-checkbox:checked { right: 0; border-color: #3B82F6; }
                    .toggle-checkbox:checked + .toggle-label { background-color: #3B82F6; }
                `}</style>
            </>
        );
    };

    const CveRepoPanel = ({ onReposUpdate }) => {
        // 列表相关的 State
        const [repos, setRepos] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(true);
        const [error, setError] = React.useState(null);

        // “新增”弹窗和表单相关的 State
        const [isModalOpen, setIsModalOpen] = React.useState(false);
        const [newRepoName, setNewRepoName] = React.useState('');
        const [newRepoContent, setNewRepoContent] = React.useState('');
        const [newRepoFileName, setNewRepoFileName] = React.useState('');
        const [isSubmitting, setIsSubmitting] = React.useState(false);

        // 【新增】“查看详情”弹窗相关的 State
        const [isViewModalOpen, setIsViewModalOpen] = React.useState(false);
        const [selectedRepo, setSelectedRepo] = React.useState(null);

        // 获取 REPO 列表的函数
        const fetchRepos = async () => {
            setIsLoading(true); 
            try {
                const response = await fetch('http://localhost:5000/api/vulnerability/repos', { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error(`HTTP 错误! 状态: ${response.status}`);
                }
                const data = await response.json();
                setRepos(data);
                if (onReposUpdate) {
                    onReposUpdate(data);
                }
            } catch (e) {
                console.error("获取 CVE REPO 列表失败:", e);
                setError(e.message);
            } finally {
                setIsLoading(false);
            }
        };

        // 在组件加载时获取数据
        React.useEffect(() => {
            fetchRepos();
        }, []);

        // “新增”弹窗关闭函数
        const handleCloseModal = () => {
            setIsModalOpen(false);
            setNewRepoName('');
            setNewRepoContent('');
            setNewRepoFileName('');
            setIsSubmitting(false);
        };

        // 处理文件上传的函数
        const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
            setNewRepoFileName(file.name);
            const reader = new FileReader();
            reader.onload = (event) => {
                setNewRepoContent(event.target.result);
            };
            reader.readAsText(file);
            }
        };
        
        // 处理 下载模板 的函数
        const handleDownloadTemplate = () => {
            const templateContent = `[example-repo]
            name=Example Repository
            baseurl=http://example.com/repo/$basearch/
            enabled=1
            gpgcheck=1
            gpgkey=http://example.com/repo/RPM-GPG-KEY-example`;
            const blob = new Blob([templateContent], { type: 'text/plain' }     );
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template.repo';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // 处理新增REPO的函数
        const handleSubmit = async () => {
            if (!newRepoName || !newRepoContent) {
                alert('REPO源名称和REPO内容均不能为空！');
                return;
            }
            setIsSubmitting(true);
            
            try {
                const response = await fetch('http://localhost:5000/api/vulnerability/repos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newRepoName, content: newRepoContent }),
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP 错误! 状态: ${response.status}`);
                }
                
                alert(`REPO源 "${newRepoName}" 添加成功`);
                handleCloseModal();
                fetchRepos(); // 重新加载列表
            } catch (error) {
                console.error("添加 REPO 失败:", error);
                alert(`添加 REPO 失败: ${error.message}`);
            } finally {
                setIsSubmitting(false);
            }
        };
        
        // 处理删除 REPO 的函数
        const handleDeleteRepo = async (repoId, repoName) => {
            if (window.confirm(`确定要删除 REPO 源 "${repoName}" 吗？`)) {
                try {
                    // 使用 DELETE 方法，并将 repoId 放在 URL 中
                    const response = await fetch(`http://localhost:5000/api/vulnerability/repos/${repoId}`, {
                        method: 'DELETE',
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP 错误! 状态: ${response.status}`);
                    }
                    alert(`REPO源 "${repoName}" 删除成功`);
                    fetchRepos(); // 重新加载列表
                } catch (error) {
                    console.error("删除 REPO 失败:", error);
                    alert(`删除 REPO 失败: ${error.message}`);
                }
            }
        };

        // 【新增】处理点击“更多”的函数
        const handleViewRepo = (repo) => {
            setSelectedRepo(repo); // 将点击的 REPO 数据存入 state
            setIsViewModalOpen(true); // 打开详情弹窗
        };

        return (
            <>
            <div className="bg-white p-6 rounded-lg shadow-md mt-6">
                <h3 className="text-base font-semibold text-gray-800 flex justify-between items-center mb-4">
                <span>CVE REPO</span>
                <span className="cursor-pointer">▲</span>
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <div 
                    onClick={() => setIsModalOpen(true)}
                    className="flex items-center justify-center w-full h-24 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 hover:border-blue-500"
                >
                    <span className="text-5xl text-gray-400 font-light">+</span>
                </div>
                
                {isLoading ? (
                    <div className="flex items-center justify-center w-full h-24 border border-gray-200 rounded-lg p-4">
                    <span className="text-gray-500">加载中...</span>
                    </div>
                ) : error ? (
                    <div className="flex items-center justify-center w-full h-24 border border-red-300 bg-red-50 rounded-lg p-4">
                    <span className="text-red-600 text-xs">加载失败: {error}</span>
                    </div>
                ) : (
                    repos.map(repo => (
                    <div key={repo.id} className="w-full h-24 border border-gray-200 rounded-lg p-4 flex flex-col justify-between">
                        <span className="font-semibold text-gray-800">{repo.name}</span>
                        <div className="text-right text-xs">
                        <a href="#" onClick={(e) => { e.preventDefault(); handleDeleteRepo(repo.id, repo.name); }} className="text-blue-600 hover:underline">删除</a>
                        {/* 【修改点】给“更多”链接绑定 handleViewRepo 事件 */}
                        <a href="#" onClick={(e) => { e.preventDefault(); handleViewRepo(repo); }} className="text-blue-600 hover:underline ml-2">更多 ∨</a>
                        </div>
                    </div>
                    ))
                )}
                </div>
            </div>

            {/* “新增”弹窗 JSX (无改动) */}
            {isModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl">
                    <div className="flex justify-between items-center p-4 border-b">
                    <h3 className="text-lg font-semibold text-gray-800">新建REPO源</h3>
                    <button onClick={handleCloseModal} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div className="p-6 space-y-4">
                    <div className="flex items-center">
                        <label className="w-28 text-sm font-medium text-gray-700 flex-shrink-0 mr-4"><span className="text-red-500 mr-1">*</span>REPO源名称:</label>
                        <input 
                        type="text" 
                        value={newRepoName}
                        onChange={(e) => setNewRepoName(e.target.value)}
                        className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        />
                    </div>
                    <div className="flex items-start">
                        <div className="w-28 flex-shrink-0 mr-4">
                        <label className="text-sm font-medium text-gray-700"><span className="text-red-500 mr-1">*</span>REPO内容:</label>
                        <button 
                            onClick={handleDownloadTemplate} 
                            className="bg-white border border-gray-300 text-gray-700 px-4 py-1.5 rounded-md hover:bg-gray-50 cursor-pointer text-sm mt-2 text-center"
                        >
                            下载模板
                        </button>
                        </div>
                        <div className="w-full">
                        <textarea 
                            value={newRepoContent}
                            onChange={(e) => setNewRepoContent(e.target.value)}
                            rows="10" 
                            className="w-full border border-gray-300 rounded-md p-2 font-mono text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                        </div>
                    </div>
                    <div className="flex items-center">
                        <label className="w-28 text-sm font-medium text-gray-700 flex-shrink-0 mr-4">上传文件:</label>
                        <div className="flex items-center space-x-2">
                        <label className="bg-white border border-gray-300 text-gray-700 px-4 py-1.5 rounded-md hover:bg-gray-50 cursor-pointer text-sm">
                            选择文件
                            <input type="file" className="hidden" accept=".repo,.txt" onChange={handleFileChange} />
                        </label>
                        {newRepoFileName && <span className="text-sm text-gray-500">{newRepoFileName}</span>}
                        </div>
                    </div>
                    </div>
                    <div className="flex justify-end items-center p-4 bg-gray-50 border-t space-x-3">
                    <button onClick={handleCloseModal} className="bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-100" disabled={isSubmitting}>取消</button>
                    <button onClick={handleSubmit} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-wait" disabled={isSubmitting}>
                        {isSubmitting ? '添加中...' : '确定'}
                    </button>
                    </div>
                </div>
                </div>
            )}

            {/* 【新增】内嵌的“查看详情”弹窗 JSX */}
            {isViewModalOpen && selectedRepo && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-lg">
                    <div className="flex justify-between items-center p-4 border-b">
                    <h3 className="text-lg font-semibold text-gray-800">REPO 详情: {selectedRepo.name}</h3>
                    <button onClick={() => setIsViewModalOpen(false)} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div className="p-6">
                    <pre className="bg-gray-50 p-4 rounded-md text-xs text-gray-800 whitespace-pre-wrap break-all">
                        {selectedRepo.content}
                    </pre>
                    </div>
                    <div className="flex justify-end items-center p-4 border-t bg-gray-50">
                    <button onClick={() => setIsViewModalOpen(false)} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700">关闭</button>
                    </div>
                </div>
                </div>
            )}
            </>
        );
        };

    const VulnerabilityHostListPage = ({ onViewHostDetails }) => {
        // State
        const [hosts, setHosts] = React.useState([]); // 存储从文件获取的、经过搜索过滤后的 *所有* 主机
        const [selectedRows, setSelectedRows] = React.useState([]);
        const [isLoading, setIsLoading] = React.useState(false);
        const [searchTerm, setSearchTerm] = React.useState(''); 
        // 分页相关的 State
        const [currentPage, setCurrentPage] = React.useState(1);
        const [pageSize, setPageSize] = React.useState(10); // 默认每页10条
        
        //【设置REPO功能】相关的State
        const [isSetRepoModalOpen, setIsSetRepoModalOpen] = React.useState(false);
        const [availableRepos, setAvailableRepos] = React.useState([]);
        const [taskName, setTaskName] = React.useState("REPO设置任务");
        const [taskDescription, setTaskDescription] = React.useState("");
        const [selectedRepoForTask, setSelectedRepoForTask] = React.useState("");
        const [isSubmittingTask, setIsSubmittingTask] = React.useState(false);
        // 【修改点】新增state，用于在打开弹窗时固化操作目标
        const [hostsForRepoTask, setHostsForRepoTask] = React.useState([]);

        //【漏洞扫描功能】相关的State
        const [isScanConfirmOpen, setIsScanConfirmOpen] = React.useState(false);

        //【导出功能】相关的State
        const [isExportConfirmOpen, setIsExportConfirmOpen] = React.useState(false);
        const [exportConfirmMessage, setExportConfirmMessage] = React.useState("");


        // 获取与显示主机列表
        const fetchHosts = async (currentSearchTerm) => {
            console.log(`开始刷新主机列表... 搜索词: "${currentSearchTerm}"`);
            setIsLoading(true);
            // 不再需要手动重置页面，因为每次搜索都是新的开始
            // setCurrentPage(1); 

            // 构建带查询参数的 URL
            const url = new URL('http://localhost:5000/api/vulnerability/hosts');
            if (currentSearchTerm) {
                url.searchParams.append('name', currentSearchTerm);
            }

            try {
                const response = await fetch(url); 
                if (!response.ok) {
                    throw new Error(`HTTP 错误! 状态: ${response.status}`);
                }
                const data = await response.json();
                setHosts(data); // 后端已完成过滤
            } catch (error) {
                console.error("获取主机列表失败:", error);
                alert(`获取主机列表失败: ${error.message}.`);
                setHosts([]);
            } finally {
                setIsLoading(false);
                setSelectedRows([]);
                setCurrentPage(1); // 确保搜索后返回第一页
            }
        };

        // 首次加载的 useEffect 保持不变
        React.useEffect(() => {
            fetchHosts(''); 
        }, []); 

        // 其他选择相关的事件处理函数保持不变
        const handleSelectAll = (e) => {
            // 全选是对当前页的数据进行操作
            const currentIds = paginatedHosts.map(h => h.id);
            const newSelectedRows = e.target.checked 
            ? [...new Set([...selectedRows, ...currentIds])]
            : selectedRows.filter(id => !currentIds.includes(id));
            setSelectedRows(newSelectedRows);
        };
        const handleSelectRow = (e, id) => setSelectedRows(e.target.checked ? [...selectedRows, id] : selectedRows.filter(rowId => rowId !== id));

        //分页事件处理函数
        const handlePageChange = (newPage) => {
            setCurrentPage(newPage);
        };

        const handlePageSizeChange = (newSize) => {
            setPageSize(newSize);
            setCurrentPage(1); // 切换每页条数时，返回第一页
        };

        //在渲染前，计算出当前页应该显示的数据
        const paginatedHosts = hosts.slice((currentPage - 1) * pageSize, currentPage * pageSize);
        
        //【设置REPO功能】获取选中的主机对象
        const getSelectedHostObjects = () => {
            return hosts.filter(host => selectedRows.includes(host.id));
        };
        
        //【设置REPO功能】打开弹窗的事件处理器
        const handleOpenSetRepoModal = () => {
            // 【修改点】修改目标主机的选择逻辑
            const selectedHostObjects = getSelectedHostObjects();
            let targetHosts;

            if (selectedHostObjects.length > 0) {
                // 1. 如果有勾选，目标就是勾选的主机
                targetHosts = selectedHostObjects;
            } else {
                // 2. 如果没有勾选，目标是当前页面的所有主机
                targetHosts = paginatedHosts;
            }
            
            if (targetHosts.length === 0) {
                alert("没有可设置REPO的主机。请先勾选主机或确保当前页面有数据。");
                return;
            }
            
            // 将本次操作的目标主机列表存入state
            setHostsForRepoTask(targetHosts);
            
            // 自动生成任务描述
            const hostIps = targetHosts.map(h => h.ip).join('、');
            setTaskDescription(`为以下${targetHosts.length}个主机设置Repo: ${hostIps}`);
            // 重置表单状态
            setTaskName("REPO设置任务");
            setSelectedRepoForTask("");
            setIsSetRepoModalOpen(true);
        };
        
        //【设置REPO功能】关闭弹窗的事件处理器
        const handleCloseSetRepoModal = () => {
            setIsSetRepoModalOpen(false);
            setIsSubmittingTask(false);
            setHostsForRepoTask([]); // 清空目标主机
        };

        //【设置REPO功能】提交任务的事件处理器
        const handleSetRepoSubmit = async (isImmediate) => {
            if (!taskName.trim()) {
            alert("任务名称不能为空！");
            return;
            }
            if (!selectedRepoForTask) {
            alert("请选择一个REPO！");
            return;
            }
            setIsSubmittingTask(true);
            
            // 【修改点】直接使用 state 中的 hostsForRepoTask 作为操作目标
            const targetHosts = hostsForRepoTask;
            const selectedRepoObject = availableRepos.find(r => r.id === selectedRepoForTask);

            try {
                // --- 准备发送到后端的数据 ---
                const payload = {
                    name: taskName,
                    description: taskDescription,
                    type: 'repo设置', // 确保类型与后端匹配
                    creationTime: new Date().toLocaleString('zh-CN', { hour12: false }),
                    
                    // --- 核心数据 ---
                    repo_id: selectedRepoForTask, // 发送所选REPO的ID
                    host_ids: targetHosts.map(h => h.id), // 发送目标主机的ID列表
                    
                    // (可选) 也可以同时发送主机详情，方便在“修复记录”页面直接显示
                    affected_hosts: targetHosts.map(h => ({
                        hostname: h.name,
                        ip: h.ip,
                        group: h.group,
                        repairStatus: '未知', 
                        repairStatusColor: 'text-gray-500'
                    }))
                };
                
                // --- 发送POST请求到通用任务创建API ---
                const response = await fetch('http://localhost:5000/api/vulnerability/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP 错误! 状态: ${response.status}`);
                }
                
                const createdTask = await response.json();

                // --- (可选) 如果是“立即执行”，则再调用执行接口 ---
                if (isImmediate) {
                    const execResponse = await fetch(`http://localhost:5000/api/vulnerability/tasks/${createdTask.id}/execute`, {
                        method: 'POST'
                    });
                    if (!execResponse.ok) throw new Error('任务创建成功，但执行失败');
                }

                // --- 成功后的操作 ---
                alert(`任务 "${taskName}" 已${isImmediate ? '开始执行' : '创建成功'}`);
                handleCloseSetRepoModal();
                setSelectedRows([]); // 清空表格勾选
                fetchHosts(searchTerm); // 强制刷新主机列表，以显示更新后的REPO

            } catch (error) {
                console.error("创建REPO设置任务失败:", error);
                alert(`创建任务失败: ${error.message}`);
            } finally {
                setIsSubmittingTask(false);
            }
        };

        //【漏洞扫描功能】实际执行扫描的函数
        const executeScan = async (targetHosts) => { 
            try {
                // 【实际API调用代码】
                // 我们将创建一个新的API端点来处理扫描任务的创建
                const response = await fetch('http://localhost:5000/api/vulnerability/scans', { // ◀ 修正2：移除 await 和 fetch 之间的点
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        host_ids: targetHosts.map(h => h.id), // 发送目标主机的ID列表
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({})); 
                    throw new Error(errorData.message || `HTTP 错误! 状态: ${response.status}`);
                }
                
                const result = await response.json();
                alert(`已为 ${targetHosts.length} 台主机创建漏洞扫描任务。任务ID: ${result.task_id}`);
                setSelectedRows([]); // 扫描开始后清空选择

            } catch (error) {
                console.error("创建漏洞扫描任务失败:", error);
                alert(`创建扫描任务失败: ${error.message}`);
            }
        };

        //【漏洞扫描功能】处理“漏洞扫描”按钮点击事件
        const handleScanClick = () => {
            const selectedHosts = getSelectedHostObjects();
            if (selectedHosts.length > 0) {
            // 如果勾选了主机，直接扫描选中的
            executeScan(selectedHosts);
            } else {
            // 如果未勾选任何主机，弹出确认框
            setIsScanConfirmOpen(true);
            }
        };

        //【漏洞扫描功能】处理确认扫描全部主机的事件
        const handleConfirmScanAll = () => {
            executeScan(hosts); // 传入当前列表中的所有主机
            setIsScanConfirmOpen(false); // 关闭确认框
        };

        //【导出功能】第一步：处理“导出”按钮点击，打开确认弹窗
        const handleExportClick = () => {
            const selectedHosts = getSelectedHostObjects();
            const totalHostCount = hosts.length;
            
            if (selectedHosts.length === 0 && totalHostCount === 0) {
                alert("没有可导出的数据。");
                return;
            }

            if (selectedHosts.length > 0) {
                setExportConfirmMessage(`确定要导出已选择的 ${selectedHosts.length} 条数据吗？`);
            } else {
                setExportConfirmMessage(`确定要导出全部 ${totalHostCount} 条数据吗？`);
            }
            setIsExportConfirmOpen(true);
        };

        //【导出功能】第二步：执行实际的导出操作
        const executeExport = () => {
            // 1. 确定要导出的数据范围
            const selectedHosts = getSelectedHostObjects();
            const dataToExport = selectedHosts.length > 0 ? selectedHosts : hosts;

            // 2. 准备CSV内容
            const header = ['主机名', 'ip地址', '主机组', 'CVE REPO', '未修复/已修复CVE', '上次扫描'];
            const rows = dataToExport.map(host => [
            host.name,
            host.ip,
            host.group,
            host.repo,
            host.cve,
            host.lastScan
            ]);

            // 将数组转换为CSV字符串
            let csvContent = header.join(',') + '\n';
            rows.forEach(rowArray => {
            // 处理包含逗号的字段，用双引号包裹
            const row = rowArray.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
            csvContent += row + '\n';
            });

            // 3. 【纯前端实现】在浏览器中生成并下载文件，暂时无后端参与
            // 创建一个Blob对象，并添加BOM头以防止Excel打开中文乱码
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建一个临时的URL指向该Blob对象
            const url = URL.createObjectURL(blob);
            
            // 创建一个隐藏的<a>标签用于触发下载
            const link = document.createElement('a');
            link.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.setAttribute('download', `vulnerability-hosts-${timestamp}.csv`);
            
            // 将<a>标签添加到DOM中，模拟点击，然后移除
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // 释放URL对象
            URL.revokeObjectURL(url);
            
            // 关闭弹窗
            setIsExportConfirmOpen(false);
        };


        return (
            <>
            <div className="bg-white p-6 rounded-lg shadow-md">
                {/* 顶部操作区 */}
                <div className="flex justify-between items-center mb-4">
                <div className="relative">
                    <input 
                    type="text" 
                    placeholder="按主机名搜索" 
                    className="border border-gray-300 rounded-md pl-4 pr-8 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                        fetchHosts(searchTerm);
                        }
                    }}
                    />
                    <svg 
                    onClick={() => fetchHosts(searchTerm)}
                    className="w-4 h-4 absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 cursor-pointer" 
                    fill="currentColor" 
                    viewBox="0 0 20 20"
                    >
                    <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd"></path>
                    </svg>
                </div>
                <div className="flex items-center space-x-2 text-sm">
                    <button onClick={handleOpenSetRepoModal} className="bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700">设置REPO</button>
                    <button onClick={handleScanClick} className="bg-blue-600 text-white px-4 py-1.5 rounded-md hover:bg-blue-700">漏洞扫描</button>
                    {/* 为“导出”按钮绑定新的点击事件 */}
                    <button onClick={handleExportClick} className="bg-white border border-gray-300 text-gray-700 px-4 py-1.5 rounded-md hover:bg-gray-50">导出</button>
                    
                    <button 
                    onClick={() => fetchHosts(searchTerm)} 
                    disabled={isLoading}
                    className="bg-white border border-gray-300 text-gray-700 px-4 py-1.5 rounded-md hover:bg-gray-50 flex items-center space-x-2"
                    >
                    <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v6h6M20 20v-6h-6M4 10a9 9 0 0115.89-3.56M20 14a9 9 0 01-15.89 3.56" />
                    </svg>
                    </button>
                </div>
                </div>  

                {/* 表格区域 */}
                <div className="overflow-x-auto">
                <table className="min-w-full text-sm text-left">
                    <thead className="bg-gray-50">
                    <tr>
                        <th className="p-3 w-10"><input type="checkbox" onChange={handleSelectAll} checked={paginatedHosts.length > 0 && paginatedHosts.every(h => selectedRows.includes(h.id     ))} /></th>
                        <th className="p-3 font-semibold text-gray-600">主机名</th>
                        <th className="p-3 font-semibold text-gray-600">ip地址</th>
                        <th className="p-3 font-semibold text-gray-600">主机组</th>
                        <th className="p-3 font-semibold text-gray-600">CVE REPO</th>
                        <th className="p-3 font-semibold text-gray-600">未修复/已修复CVE</th>
                        <th className="p-3 font-semibold text-gray-600">上次扫描</th>
                    </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                    {isLoading ? (
                        <tr><td colSpan="7" className="p-10 text-center text-gray-500">加载中...</td></tr>
                        ) : paginatedHosts.length > 0 ? ( // 渲染分页后的数据
                        paginatedHosts.map(host => (
                        <tr key={host.id} className="hover:bg-gray-50">
                            <td className="p-3"><input type="checkbox" checked={selectedRows.includes(host.id)} onChange={(e) => handleSelectRow(e, host.id)} /></td>
                            <td className="p-3"><a href="#" onClick={(e) => { e.preventDefault(); onViewHostDetails(host); }} className="text-blue-600 hover:underline">{host.name}</a></td>
                            <td className="p-3 text-gray-800">{host.ip}</td>
                            <td className="p-3 text-gray-800">{host.group}</td>
                            <td className="p-3 text-gray-800">{host.repo}</td>
                            <td className="p-3 text-gray-800">{host.cve}</td>
                            <td className="p-3 text-gray-800">{host.lastScan}</td>
                        </tr>
                        ))
                    ) : (
                        <tr><td colSpan="7" className="p-10 text-center text-gray-500">未找到匹配的主机</td></tr>
                    )}
                    </tbody>
                </table>
                </div>
                
                {/* 分页区域 */}
                <div className="flex justify-end items-center pt-4 text-sm">
                {/* 总计显示的是过滤后的总数 */}
                <span>总计 {hosts.length} 项</span>
                <div className="ml-4">
                    {/* 将 state 和事件处理函数传递给 Pagination 组件 */}
                    <Pagination 
                    currentPage={currentPage} 
                    totalItems={hosts.length} 
                    pageSize={pageSize} 
                    onPageChange={handlePageChange} 
                    onPageSizeChange={handlePageSizeChange} 
                    />
                </div>
                </div>
            </div>

            <CveRepoPanel onReposUpdate={setAvailableRepos} />

            {/*【设置REPO功能】弹窗JSX */}
            {isSetRepoModalOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl">
                    <div className="flex justify-between items-center p-4 border-b">
                    <h3 className="text-lg font-semibold text-gray-800">设置REPO</h3>
                    <button onClick={handleCloseSetRepoModal} className="text-gray-500 hover:text-gray-800 text-2xl" disabled={isSubmittingTask}>×</button>
                    </div>
                    <div className="p-6 space-y-4 text-sm">
                    {/* 任务类型 */}
                    <div className="flex items-center">
                        <label className="w-24 text-right font-medium text-gray-700 mr-4">任务类型:</label>
                        <span className="text-gray-900">repo设置</span>
                    </div>
                    {/* 任务名称 */}
                    <div className="flex items-center">
                        <label className="w-24 text-right font-medium text-gray-700 mr-4"><span className="text-red-500 mr-1">*</span>任务名称:</label>
                        <input 
                        type="text" 
                        value={taskName}
                        onChange={(e) => setTaskName(e.target.value)}
                        className="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        />
                    </div>
                    {/* 【修改点】任务描述变为可编辑 */}
                    <div className="flex items-start">
                        <label className="w-24 text-right font-medium text-gray-700 mr-4 pt-2"><span className="text-red-500 mr-1">*</span>任务描述:</label>
                        <textarea 
                        value={taskDescription}
                        onChange={(e) => setTaskDescription(e.target.value)}
                        rows="3" 
                        className="w-full border border-gray-300 rounded-md p-2 bg-white text-gray-900 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        ></textarea>
                    </div>
                    {/* 选择REPO */}
                    <div className="flex items-center">
                        <label className="w-24 text-right font-medium text-gray-700 mr-4"><span className="text-red-500 mr-1">*</span>选择REPO:</label>
                        <select 
                        value={selectedRepoForTask}
                        onChange={(e) => setSelectedRepoForTask(e.target.value)}
                        className="w-full border border-gray-300 rounded-md p-2 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                        <option value="" disabled>请选择REPO</option>
                        {availableRepos.map(repo => (
                            <option key={repo.id} value={repo.id}>{repo.name}</option>
                        ))}
                        </select>
                    </div>
                    {/* 【修改点】目标主机列表使用 hostsForRepoTask */}
                    <div className="border-t pt-4 mt-4">
                        <p className="font-medium text-gray-700 mb-2">本次任务将对以下 {hostsForRepoTask.length} 台主机生效</p>
                        <div className="max-h-48 overflow-y-auto border rounded-md">
                        <table className="min-w-full text-sm text-left">
                            <thead className="bg-gray-100 sticky top-0">
                            <tr>
                                <th className="p-2 w-10"><input type="checkbox" checked readOnly /></th>
                                <th className="p-2 font-semibold text-gray-600">主机名称</th>
                                <th className="p-2 font-semibold text-gray-600">ip地址</th>
                            </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                            {hostsForRepoTask.map(host => (
                                <tr key={host.id}>
                                <td className="p-2"><input type="checkbox" checked readOnly /></td>
                                <td className="p-2 text-gray-800">{host.name}</td>
                                <td className="p-2 text-gray-800">{host.ip}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                        </div>
                    </div>
                    </div>
                    <div className="flex justify-end items-center p-4 bg-gray-50 border-t space-x-3">
                    <button onClick={handleCloseSetRepoModal} className="bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-100" disabled={isSubmittingTask}>取消</button>
                    <button onClick={() => handleSetRepoSubmit(false)} className="bg-white border border-blue-600 text-blue-600 font-semibold py-2 px-4 rounded-md hover:bg-blue-50" disabled={isSubmittingTask}>
                        {isSubmittingTask ? '处理中...' : '创建'}
                    </button>
                    <button onClick={() => handleSetRepoSubmit(true)} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50" disabled={isSubmittingTask}>
                        {isSubmittingTask ? '处理中...' : '立即执行'}
                    </button>
                    </div>
                </div>
                </div>
            )}

            {/*【漏洞扫描功能】确认弹窗JSX */}
            {isScanConfirmOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-sm">
                    <div className="p-6 text-center">
                    <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                        <svg className="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <h3 className="text-lg font-medium text-gray-900">确定扫描全部主机？</h3>
                    </div>
                    <div className="flex justify-center items-center p-4 bg-gray-50 border-t space-x-4">
                    <button onClick={( ) => setIsScanConfirmOpen(false)} className="bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-md hover:bg-gray-100">
                        取消
                    </button>
                    <button onClick={handleConfirmScanAll} className="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">
                        确定
                    </button>
                    </div>
                </div>
                </div>
            )}

            {/*【导出功能】确认弹窗JSX */}
            {isExportConfirmOpen && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                <div className="bg-white rounded-lg shadow-xl w-full max-w-sm">
                    <div className="p-6 text-center">
                    <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                        <svg className="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </div>
                    <h3 className="text-lg font-medium text-gray-900">{exportConfirmMessage}</h3>
                    </div>
                    <div className="flex justify-center items-center p-4 bg-gray-50 border-t space-x-4">
                    <button onClick={( ) => setIsExportConfirmOpen(false)} className="bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-md hover:bg-gray-100">
                        取消
                    </button>
                    <button onClick={executeExport} className="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">
                        确定导出
                    </button>
                    </div>
                </div>
                </div>
            )}
            </>
        );
        };
    //主机列表组件结束